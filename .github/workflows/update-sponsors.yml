name: Update Sponsors

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-sponsors:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch sponsors and update only if changed
        env:
          GH_TOKEN: ${{ secrets.SPONSORS_TOKEN }}
        run: |
          set -euo pipefail

          # Use a workspace-local temp dir (guaranteed writable) and ensure permissions
          mkdir -p docs/public tmp
          chmod 0777 tmp

          # Write query to a file to avoid quoting issues
          cat > tmp/query.graphql <<'GRAPHQL'
          query {
            user(login: "gronxb") {
              sponsorshipsAsMaintainer(first: 100, includePrivate: false) {
                nodes {
                  sponsorEntity {
                    ... on User {
                      login
                      avatarUrl
                      name
                      url
                    }
                    ... on Organization {
                      login
                      avatarUrl
                      name
                      url
                    }
                  }
                }
              }
            }
          }
          GRAPHQL

          # Fetch raw GraphQL response using gh and redirect output to file
          gh api graphql -f query=@tmp/query.graphql --silent > tmp/raw.json

          # Extract normalized sponsors array (no updatedAt)
          jq '[.data.user.sponsorshipsAsMaintainer.nodes[].sponsorEntity
                | select(. != null)
                | { login, avatarUrl, name, url }]'
            tmp/raw.json > tmp/new-sponsors.json

          # Prepare sorted representations for comparison (sort by login to ignore ordering)
          jq 'sort_by(.login // "")' tmp/new-sponsors.json > tmp/new-sorted.json

          if [ -f docs/public/sponsors.json ]; then
            jq '(.sponsors // []) | sort_by(.login // "")' docs/public/sponsors.json > tmp/old-sorted.json || echo '[]' > tmp/old-sorted.json
          else
            echo '[]' > tmp/old-sorted.json
          fi

          # If sponsor arrays are identical, do nothing (no updatedAt bump)
          if cmp -s tmp/old-sorted.json tmp/new-sorted.json; then
            echo "No sponsor changes detected — not updating docs/public/sponsors.json"
          else
            # Create the full file with updatedAt because sponsors changed
            jq -n --argjson sponsors "$(cat tmp/new-sponsors.json)" '{sponsors:$sponsors, updatedAt: now | todate}' > docs/public/sponsors.json
            echo "Sponsors changed — docs/public/sponsors.json updated"
          fi

      - name: Commit and push
        run: |
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "github-actions[bot]"

          # only add if file exists (it may not have been written)
          if [ -f docs/public/sponsors.json ]; then
            git add docs/public/sponsors.json
          fi

          if git diff --cached --quiet; then
            echo "No staged changes to commit"
          else
            git commit -m "chore: update sponsors list"
            git push
          fi
