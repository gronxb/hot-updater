name: Update Sponsors

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-sponsors:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fetch sponsors (update updatedAt only when sponsors changed)
        env:
          GH_TOKEN: ${{ secrets.SPONSORS_TOKEN }}
        run: |
          set -euo pipefail
          mkdir -p docs/public

          # 1) 새 sponsors 목록만 생성 (updatedAt 제외)
          gh api graphql -f query='
            query {
              user(login: "gronxb") {
                sponsorshipsAsMaintainer(first: 100, includePrivate: false) {
                  nodes {
                    sponsorEntity {
                      ... on User {
                        login
                        avatarUrl
                        name
                        url
                      }
                      ... on Organization {
                        login
                        avatarUrl
                        name
                        url
                      }
                    }
                  }
                }
              }
            }
          ' | jq '[
            .data.user.sponsorshipsAsMaintainer.nodes[].sponsorEntity
            | select(. != null)
            | { login, avatarUrl, name, url }
          ]
          | sort_by(.login)' > /tmp/sponsors.new.json

          # 2) 기존 sponsors 추출 (없으면 빈 배열), 기존 updatedAt도 읽어둠
          if [ -f docs/public/sponsors.json ]; then
            jq '.sponsors // [] | sort_by(.login)' docs/public/sponsors.json > /tmp/sponsors.old.json
            oldUpdatedAt=$(jq -r '.updatedAt // empty' docs/public/sponsors.json)
          else
            echo '[]' > /tmp/sponsors.old.json
            oldUpdatedAt=""
          fi

          # 3) sponsors가 동일하면 updatedAt 유지, 다르면 now로 갱신
          if diff -q /tmp/sponsors.old.json /tmp/sponsors.new.json >/dev/null; then
            jq --arg updatedAt "$oldUpdatedAt" \
              '{ sponsors: (input), updatedAt: $updatedAt }' \
              /tmp/sponsors.new.json > docs/public/sponsors.json
          else
            jq '{ sponsors: (input), updatedAt: (now | todate) }' \
              /tmp/sponsors.new.json > docs/public/sponsors.json
          fi

      - name: Commit and push
        run: |
          git diff --quiet docs/public/sponsors.json || (
            git config user.email "github-actions[bot]@users.noreply.github.com"
            git config user.name "github-actions[bot]"
            git add docs/public/sponsors.json
            git commit -m "chore: update sponsors list"
            git push
          )
